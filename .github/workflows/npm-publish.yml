name: "Publish to MyGet"
on:
  push:
    branches:
    - internal
jobs:
  publish-npm:
    name: ğŸ› ï¸ Build and Publish NPM Package
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.npm-publish.outputs.version }}
    steps:
    - name: "ğŸšš Get Latest Code"
      uses: actions/checkout@v3
    - name: "âš™ï¸ Use Node.js 16"
      uses: actions/setup-node@v3
      with:
        node-version: 16
    - run: npm install
    - run: |
        sed -i -e 's/ionic-pullup/\@cmnhospitals\/ionic-pullup/g' projects/ionic-pullup/package.json
        sed -i -e 's/arielfaur/cmnhospitals/g' projects/ionic-pullup/package.json
    - run: |
        npm run build-lib
        echo "//www.myget.org/F/cmnhospitalsnpm/npm/:_authToken=${{ secrets.NPM_TOKEN }}" >> ./dist/ionic-pullup/.npmrc
    - uses: JS-DevTools/npm-publish@v1
      id: npm-publish
      with:
        token: ${{ secrets.NPM_TOKEN }}
        package: ./dist/ionic-pullup/package.json
        registry: https://www.myget.org/F/cmnhospitalsnpm/npm/
        greater-version-only: true
  version:
    name: ğŸ· Bump version and push tag
    runs-on: ubuntu-latest
    needs: publish-npm
    steps:
      - uses: cmnhospitals/github-tag-action@2.0.0
        env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            CUSTOM_TAG: v${{ needs.publish-npm.outputs.version }}
